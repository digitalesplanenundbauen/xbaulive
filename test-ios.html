<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- AR.js (location-based) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

    <style>
      html, body { margin: 0; padding: 0; height: 100%; overflow: hidden; background: #000; }
      /* Start-Overlay */
      #start-overlay{
        position:fixed; inset:0;
        display:flex; align-items:center; justify-content:center;
        flex-direction:column; gap:12px;
        background: #111; color:#fff; font-family:sans-serif; z-index: 9999;
      }
      #start-overlay button{
        font-size:16px; padding:10px 16px; border:0; border-radius:10px; cursor:pointer;
      }
      /* Infofenster unten (Debug) */
      #info-box {
        position: fixed;
        bottom: 0; left: 0; width: 100%;
        background: rgba(221,221,221,0.85);
        color: #000; font-family: monospace; font-size: 12px;
        padding: 8px 10px; box-sizing: border-box; text-align: left;
        max-height: 30vh; overflow: auto; z-index: 9998;
      }
      .hint {opacity: 0.8; font-size: 12px;}
    </style>
  </head>

  <body>
    <!-- Start-Overlay (erzwingt User-Geste auf iOS) -->
    <div id="start-overlay">
      <div style="max-width:600px;text-align:center;padding:0 16px;">
        <h3>xBauViewer – AR Start</h3>
        <p class="hint">
          Bitte tippen, um Kamera, Standort und Bewegungssensor zu aktivieren (iOS erfordert eine Nutzerinteraktion).
          Stelle sicher: HTTPS, präziser Standort & „Bewegung & Ausrichtung“ sind erlaubt.
        </p>
      </div>
      <button id="start-btn">Start</button>
    </div>

    <a-scene
      renderer="logarithmicDepthBuffer: true; alpha: true;"
      embedded
      loading-screen="enabled: false;"
      vr-mode-ui="enabled: false"
      arjs="sourceType: webcam; facingMode: environment; gpsMinDistance: 2; debugUIEnabled: false;"
    >
      <a-assets>
        <!-- CORS-freundlich laden -->
        <a-asset-item id="animated-asset" crossorigin="anonymous" src="assets/gameobjectohnekellerreduziert.glb"></a-asset-item>
      </a-assets>

      <a-entity
        id="model"
        gltf-model="#animated-asset"
        scale="0.8 0.8 0.8"
        gps-entity-place="latitude: 47.867615758; longitude: 12.109218307;">
      </a-entity>

      <!-- Kamera mit northOffset (Script passt dynamisch an) -->
      <a-camera id="cam" gps-camera="minAccuracy: 50; northOffset: 0" rotation-reader></a-camera>

      <!-- Optional: AR.js UI-Komponente für iOS-Orientation-Permission -->
      <a-entity device-orientation-permission-ui="enabled: true"></a-entity>
    </a-scene>

    <div id="info-box">Log startet…<br>Version: 1.7</div>

    <script>
      // --- Mini-Logger in die Info-Box ---
      const logBox = document.getElementById('info-box');
      function log(msg){ logBox.innerHTML += '<br>' + (typeof msg === 'string' ? msg : JSON.stringify(msg)); }

      // --- iOS-Erkennung ---
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

      // --- iOS 90°-Yaw-Fix per northOffset ---
      function getOrientationAngle(){
        if (screen.orientation && typeof screen.orientation.angle === 'number') return screen.orientation.angle;
        return (typeof window.orientation === 'number') ? window.orientation : 0;
      }
      function applyNorthOffsetForIOS(){
        const cam = document.getElementById('cam');
        if (!cam) return;
        const angle = getOrientationAngle();
        const needsLandscapeFix = Math.abs(angle) === 90;
        const offset = needsLandscapeFix ? 90 : 0; // falls falsch herum: -90 probieren
        const current = cam.getAttribute('gps-camera') || {};
        cam.setAttribute('gps-camera', Object.assign({}, current, { northOffset: offset }));
        log('northOffset gesetzt auf: ' + offset + ' (angle=' + angle + ')');
      }

      // --- Permissions per Button abfragen ---
      async function requestMotionPermissionIfNeeded(){
        try{
          if (isIOS && typeof DeviceOrientationEvent !== 'undefined' &&
              typeof DeviceOrientationEvent.requestPermission === 'function'){
            const res = await DeviceOrientationEvent.requestPermission();
            log('DeviceOrientation permission: ' + res);
          }
        }catch(e){ log('DeviceOrientation error: ' + e); }
      }

      async function requestGeoOnce(){
        return new Promise((resolve) => {
          if (!('geolocation' in navigator)) { log('Geolocation nicht verfügbar'); resolve(false); return; }
          navigator.geolocation.getCurrentPosition(
            (pos)=>{ log('Geolocation OK: ' + pos.coords.latitude.toFixed(6) + ', ' + pos.coords.longitude.toFixed(6) + ' (acc≈' + pos.coords.accuracy + 'm)'); resolve(true); },
            (err)=>{ log('Geolocation Fehler: ' + err.message); resolve(false); },
            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
          );
        });
      }

      async function requestCameraPrewarm(){
        // A-Frame/AR.js kümmert sich eigentlich um getUserMedia.
        // Auf manchen iOS-Versionen hilft ein „Prewarm“ unter User-Geste.
        try{
          if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) { log('getUserMedia nicht verfügbar'); return; }
          const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' }, audio: false });
          // Sofort wieder stoppen – Zweck ist nur die Permission.
          stream.getTracks().forEach(t=>t.stop());
          log('Kamera-Prewarm OK');
        }catch(e){ log('Kamera-Prewarm Fehler: ' + e.message); }
      }

      // --- Start-Klick: alles nacheinander anwerfen ---
      document.getElementById('start-btn').addEventListener('click', async ()=>{
        log('Start gedrückt');
        await requestMotionPermissionIfNeeded();
        await requestGeoOnce();
        await requestCameraPrewarm();
        if (isIOS) {
          applyNorthOffsetForIOS();
          window.addEventListener('orientationchange', applyNorthOffsetForIOS);
        }
        // Overlay ausblenden
        document.getElementById('start-overlay').style.display = 'none';
      });

      // --- A-Frame / AR.js Event-Logs ---
      window.addEventListener('camera-init', (ev)=> log('camera-init: OK'));
      window.addEventListener('camera-error', (ev)=> log('camera-error: ' + (ev && ev.detail && ev.detail.error ? ev.detail.error.message : 'unbekannt')));

      const sceneEl = document.querySelector('a-scene');
      sceneEl.addEventListener('loaded', ()=> log('Scene loaded'));
      const camEl = document.getElementById('cam');

      camEl.addEventListener('gps-camera-update-position', (e)=>{
        const c = e.detail.position || {};
        log('gps-camera position: ' + JSON.stringify(c));
      });

      const modelEl = document.getElementById('model');
      modelEl.addEventListener('model-error', (e)=> log('model-error: ' + JSON.stringify(e.detail || {})));
      modelEl.addEventListener('model-loaded', ()=> log('model-loaded'));
    </script>
  </body>
</html>
