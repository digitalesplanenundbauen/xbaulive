<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live – AR-Modus</title>
  <!-- =======================
       Grundstyling
       ======================= -->
  <style>
    :root{ --bg:#ffffff; --text:#212121; --muted:#4b5563; --accent:#F39205; --border:rgba(0,0,0,0.08); --radius:0 }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0 }
    body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg); display:grid; grid-template-rows:auto 1fr auto; min-height:100dvh; overflow:hidden }
    header{ 
      text-align:center; 
      position:sticky; 
      top:0; 
      z-index:10; 
      background:#fff; 
      border-bottom:1px solid #d0d0d0; /* dünnere Linie wie in index.html */
    }
    .header-inner{ max-width:1200px; margin:0 auto; padding:16px 20px; display:flex; align-items:center; justify-content:center; gap:18px }
    .site-title{ text-align:left; line-height:1.1 }
    .site-title .top,.site-title .bottom{ font-weight:700; font-size:clamp(20px,3vw,28px) }
    .logo{ height:clamp(40px,4.3vw,60px); width:auto }
    main{ position:relative; min-height:0 }
    #content-preview{ position:absolute; inset:0; background:transparent }
    a-scene{ 
      width:100%; 
      height:100%; 
      display:block; 
      touch-action:none; 
      background:transparent !important;
      /* entferne position/max-width/max-height */
    }
    footer{ 
      position:sticky; 
      bottom:0; 
      z-index:10; 
      background:#fff; 
      border-top:1px solid #d0d0d0; /* dünnere Linie wie in index.html */
      text-align:center 
    }
    .footer-inner{ max-width:1200px; margin:0 auto; padding:17px 22px; display:flex; gap:17px; align-items:center; justify-content:center; flex-wrap:wrap }
    .live-btn{ background:var(--accent); color:#0b0c10; font-weight:800; letter-spacing:0.3px; font-size:clamp(17px,2.6vw,20px); padding:14px 25px; border:0; border-radius:var(--radius); cursor:pointer }
    .footer-text{ font-size:clamp(15px,2.3vw,18px); color:var(--muted) }
    .footer-secondary {
      background: #fff;
      border-top: 1px solid #d0d0d0;
      border-bottom: 1px solid #d0d0d0; /* dünnere untere Trennlinie */
      text-align: center;
      font-size: 11px;
      padding: 0;
    }
    .footer-secondary-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 5px 18px 5px 18px;
    }
    .footer-lab {
      color: #4b5563;
      font-size: 11px;
      font-weight: 400;
    }
    .footer-lab strong {
      font-weight: 500;
    }
    /* Vollflächiges, zugeschnittenes Kamerabild (verhindert Über-/Unter-Skalierung) */
    #arjs-video{
      position:absolute!important;
      inset:0!important;
      width:100%!important;
      height:100%!important;
      object-fit:cover!important;
      transform:none!important;
      max-width:none!important;
      max-height:none!important;
      background:#000;
    }
    /* Falls A-Frame Canvas kleiner wird -> trotzdem strecken */
    a-scene, .a-canvas{
      width:100%!important;
      height:100%!important;
    }
    /* kleines Diagnose-Overlay (optional, nur bei ?debug=1 sichtbar) */
    #ar-debug {
      position: fixed; left: 8px; top: 8px; z-index: 99999;
      font: 11px/1.3 ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      background: rgba(0,0,0,0.65); color: #fff; padding: 8px 10px; border-radius: 4px; max-width: 70vw; display:none;
      white-space: pre; pointer-events: none;
    }
  </style>
  <!-- =======================
       A-Frame + AR.js
       ======================= -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
</head>
<body>
  <!-- =======================
       Kopfzeile
       ======================= -->
  <header>
    <div class="header-inner">
      <div class="site-title">
        <div class="top">Technologiepark</div>
        <div class="bottom">&amp; Studierendenzentrum</div>
      </div>
      <img class="logo" src="./images/thlogoweiss.svg" alt="Logo" />
    </div>
  </header>

  <!-- =======================
       Hauptbereich: AR-Szene
       ======================= -->
  <main>
    <div id="content-preview">
      <a-scene
        renderer="logarithmicDepthBuffer: true; alpha: true;"
        embedded
        loading-screen="enabled: false;"
        xr-mode-ui="enabled: false"
        arjs="sourceType: webcam; gpsMinDistance: 2; debugUIEnabled: false;">
        <!-- GLB aus Assets (sauberes Preload) -->
        <a-assets>
          <a-asset-item id="animated-asset" src="./assets/gameobjectohnekellerreduziert.glb"></a-asset-item>
        </a-assets>
        <!-- Welt-Node + Geoposition -->
        <a-entity id="world-yaw" rotation="0 0 0">
          <a-entity gps-entity-place="latitude: 47.867615758; longitude: 12.109218307;">
            <a-entity gltf-model="#animated-asset" scale="0.8 0.8 0.8" position="-20 -4 -10"></a-entity>
          </a-entity>
        </a-entity>
        <!-- Kamera (Simulation an / echtes GPS per Button) -->
        <a-camera id="cam" gps-camera="simulateLatitude: 47.866880722; simulateLongitude: 12.109128178;" rotation-reader></a-camera>
      </a-scene>
    </div>
  </main>

  <!-- =======================
       Fußzeile
       ======================= -->
  <footer>
    <div class="footer-inner">
      <button class="live-btn" id="backBtn">Zurück</button>
      <button class="live-btn" id="gpsBtn">GPS ein</button>
    </div>
  </footer>
  <footer class="footer-secondary">
    <div class="footer-secondary-inner">
      <span class="footer-lab"><strong>Labor für digitales Planen und Bauen</strong> – Raum S 0.36</span>
    </div>
  </footer>
  <style>
    .footer-secondary {
      background: #fff;
      border-top: 1px solid #d0d0d0;
      border-bottom: 1px solid #d0d0d0; /* dünnere untere Trennlinie */
      text-align: center;
      font-size: 11px;
      padding: 0;
    }
    .footer-secondary-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 5px 18px 5px 18px;
    }
    .footer-lab {
      color: #4b5563;
      font-size: 11px;
      font-weight: 400;
    }
    .footer-lab strong {
      font-weight: 500;
    }
  </style>

  <!-- =======================
       Interaktion & Funktion
       ======================= -->
  <script>
    // Navigation zurück zur Startseite
    document.getElementById('backBtn')?.addEventListener('click',()=>location.href='index.html');

    // iOS-Orientierungsfix (richtet Modell korrekt zur Gerätelage aus)
    (function(){
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      if(!isIOS) return;
      const world = document.getElementById('world-yaw'); if(!world) return;
      const OFFSETS = { 'portrait-primary':0, 'portrait-secondary':180, 'landscape-primary':90, 'landscape-secondary':-90 };
      const ang = ()=> (screen.orientation && typeof screen.orientation.angle==='number') ? screen.orientation.angle
                    : (typeof window.orientation==='number' ? window.orientation : 0);
      const norm = a=>{ a=((a%360)+360)%360; if(a>180)a-=360; return a; };
      function type(){ const a=norm(ang()); if(a===0)return'portrait-primary'; if(Math.abs(a)===180)return'portrait-secondary'; if(a===90)return'landscape-primary'; if(a===-90)return'landscape-secondary'; return'portrait-primary'; }
      function apply(){ world.setAttribute('rotation',`0 ${ { 'portrait-primary':0,'portrait-secondary':180,'landscape-primary':90,'landscape-secondary':-90 }[type()] } 0`); }
      apply(); window.addEventListener('orientationchange',apply);
    })();

    /* Vereinheitlichte Orientierungs- & Video-Korrektur (plattformübergreifend) */
    (function(){
      const world = document.getElementById('world-yaw');
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
        (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      if(!world) return;

      function getScreenOrientationAngle(){
        return (screen.orientation && typeof screen.orientation.angle === 'number')
          ? screen.orientation.angle
          : (typeof window.orientation === 'number' ? window.orientation : 0);
      }
      function norm(a){ a=((a%360)+360)%360; if(a>180)a-=360; return a; }
      function orientationType(){
        const a = norm(getScreenOrientationAngle());
        if(a===0) return 'portrait-primary';
        if(Math.abs(a)===180) return 'portrait-secondary';
        if(a===90) return 'landscape-primary';
        if(a===-90) return 'landscape-secondary';
        return 'portrait-primary';
      }

      // Nur anpassen wenn Plattform falsch rotiert rendert (Firefox/Android in Landscape)
      function applyWorldRotation(){
        const type = orientationType();
        // iOS: belasse Original (bereits stabil) -> 0° (kein zusätzliches Mapping nötig)
        if(isIOS) return;
        const map = {
          'portrait-primary':   0,
          'portrait-secondary': 180,
          'landscape-primary':  90,   // ggf. anpassen falls 90° falsch -> auf -90 setzen
          'landscape-secondary':-90
        };
        const y = map[type] ?? 0;
        world.setAttribute('rotation', `0 ${y} 0`);
      }

      // Video-Korrektur: Einige Browser liefern rotiertes/nicht skaliertes Video
      function fixVideoOrientation(){
        const v = document.getElementById('arjs-video');
        if(!v || !v.videoWidth || !v.videoHeight) return;

        const vw = v.videoWidth;
        const vh = v.videoHeight;
        const winW = window.innerWidth;
        const winH = window.innerHeight;

        // Heuristik: Wenn Seitenverhältnis Fenster vs. Video quer/hoch vertauscht ist
        const windowIsLandscape = winW > winH;
        const videoIsLandscape = vw > vh;

        // Rücksetzen
        v.style.transform = 'none';

        // Fall: Browser dreht intern (z.B. Firefox Landscape zeigt Portrait-Video)
        if(windowIsLandscape && !videoIsLandscape){
          // Rotieren um 90°, danach Zuschneiden via scale
          v.style.transform = 'rotate(90deg) scale(1.333)'; // scale heuristisch, verhindert schwarze Ränder
          v.style.transformOrigin = 'center center';
        } else if(!windowIsLandscape && videoIsLandscape){
          // Portrait Fenster aber Landscape Video -> evtl. 90° drehen
          v.style.transform = 'rotate(-90deg) scale(1.333)';
          v.style.transformOrigin = 'center center';
        }
        // object-fit cover sorgt für restliches Füllen
      }

      function fullUpdate(){
        applyWorldRotation();
        fixVideoOrientation();
      }

      // Wiederholt versuchen bis Videodaten verfügbar
      let retries = 0;
      function retryLoop(){
        fullUpdate();
        const v = document.getElementById('arjs-video');
        if(retries < 15 && (!v || !v.videoWidth)) {
          retries++;
          setTimeout(retryLoop, 200);
        }
      }

      window.addEventListener('orientationchange', ()=>setTimeout(fullUpdate, 120));
      screen.orientation && screen.orientation.addEventListener?.('change', ()=>setTimeout(fullUpdate, 120));
      window.addEventListener('resize', ()=>setTimeout(fullUpdate, 120));

      // Start
      retryLoop();
    })();

    // Ergänzung: Szene-Loaded Event für initiale Fixes
    document.querySelector('a-scene')?.addEventListener('loaded', ()=>{
      setTimeout(()=>{
        const v=document.getElementById('arjs-video');
        if(v){
          v.setAttribute('playsinline','true');
          v.setAttribute('webkit-playsinline','true');
        }
      },200);
    });

    // Optional: leicht höhere Genauigkeit wenn echtes GPS aktiv (verhindert "Springen")
    // ...existing code (GPS Toggle bleibt unverändert)...
    // ========= AR.js Diagnose & Patches (aktivierbar mit ?debug=1) =========
    (function(){
      const params = new URLSearchParams(location.search);
      const DEBUG = /(?:\?|&)debug=1(?:&|$)/.test(location.search);
      const FORCE_ROT_DEG = params.has('vfix') ? (parseFloat(params.get('vfix')||'0') || 0) : null; // z.B. 90, -90, 0
      const FORCE_SCALE = params.has('vscale') ? (parseFloat(params.get('vscale')||'1') || 1) : null;

      const isFF = /Firefox/i.test(navigator.userAgent);
      const $overlay = document.getElementById('ar-debug');
      if (DEBUG && $overlay) $overlay.style.display = 'block';

      const state = {
        lastRotate: 'none',
        lastScale: '1',
        lastWorldY: null,
        notes: []
      };

      function logOverlay() {
        if (!$overlay || !DEBUG) return;
        const v = document.getElementById('arjs-video');
        const vw = v?.videoWidth || 0, vh = v?.videoHeight || 0;
        const winW = innerWidth, winH = innerHeight;
        const orientation = (screen.orientation && typeof screen.orientation.type === 'string') ? screen.orientation.type : 'n/a';
        const angle = (screen.orientation && typeof screen.orientation.angle === 'number') ? screen.orientation.angle : (typeof window.orientation === 'number' ? window.orientation : 0);

        $overlay.textContent =
`AR Debug (beta)
UA: ${navigator.userAgent.split(')')[0]})
isFF: ${isFF}
win: ${winW}x${winH} dpr=${devicePixelRatio}
video: ${vw}x${vh}
screen.orientation: ${orientation}, angle: ${angle}
world-yaw: ${state.lastWorldY ?? 'n/a'}
video transform: rotate(${state.lastRotate}) scale(${state.lastScale})
notes: ${state.notes.join(' | ')}`;
        state.notes = [];

        // Zusätzlich in die Konsole loggen (nur Debug)
        if (DEBUG) {
          console.debug('[ARDBG]', {
            ua: navigator.userAgent,
            win: `${innerWidth}x${innerHeight}`,
            dpr: devicePixelRatio,
            video: (function(){ const v=document.getElementById('arjs-video'); return v?`${v.videoWidth}x${v.videoHeight}`:'0x0'; })(),
            worldYaw: state.lastWorldY,
            transform: { rotate: state.lastRotate, scale: state.lastScale },
            notes: state.notes.slice(0)
          });
        }
      }

      function waitForVideo(cb, tries=0) {
        const v = document.getElementById('arjs-video');
        if (v && (v.readyState >= 1 || v.videoWidth || tries > 30)) return cb(v);
        setTimeout(()=>waitForVideo(cb, tries+1), 200);
      }

      // Heuristik: dreht das Video wenn Fenster- vs. Videoseitenverhältnis nicht passt (Firefox-Android Bug)
      function applyVideoTransform(v) {
        if (!v) return;
        const vw = v.videoWidth, vh = v.videoHeight;
        const winW = innerWidth, winH = innerHeight;
        const windowIsLandscape = winW > winH;
        const videoIsLandscape = vw > vh;

        // Baseline-Styles (neutralisieren AR.js margin tricks)
        v.style.position = 'absolute';
        v.style.inset = '0';
        v.style.width = '100%';
        v.style.height = '100%';
        v.style.objectFit = 'cover';
        v.style.margin = '0';
        v.style.left = '0';
        v.style.top = '0';

        // Reset
        let rotate = 'none', scale = '1';

        // Forced test via URL parameters has highest priority
        if (FORCE_ROT_DEG !== null) {
          rotate = `${FORCE_ROT_DEG}deg`;
          if (FORCE_SCALE !== null) scale = `${FORCE_SCALE}`;
          state.notes.push(`force vfix=${FORCE_ROT_DEG} vscale=${FORCE_SCALE ?? '1'}`);
        } else {
          // ...existing heuristic for Firefox...
          const vw = v.videoWidth, vh = v.videoHeight;
          const winW = innerWidth, winH = innerHeight;
          const windowIsLandscape = winW > winH;
          const videoIsLandscape = vw > vh;

          if (isFF && vw && vh) {
            if (windowIsLandscape && !videoIsLandscape) {
              rotate = '90deg';
            } else if (!windowIsLandscape && videoIsLandscape) {
              rotate = '-90deg';
            }
          }
          if (rotate !== 'none') scale = '1.15';
        }

        v.style.transform = `rotate(${rotate}) scale(${scale})`;
        v.style.transformOrigin = 'center center';
        state.lastRotate = rotate;
        state.lastScale = scale;
      }

      function applyWorldRotation() {
        const world = document.getElementById('world-yaw');
        if (!world) return;
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                      (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        if (isIOS) { state.lastWorldY = 'iOS: unchanged'; return; }

        const angle = (screen.orientation && typeof screen.orientation.angle === 'number')
          ? screen.orientation.angle
          : (typeof window.orientation === 'number' ? window.orientation : 0);

        // Mappe winklig auf Y-Rotation (Android/Firefox Landscape-Korrektur)
        const a = ((angle % 360) + 360) % 360;
        const map = { 0:0, 90:90, 180:180, 270:-90 };
        const y = map[a] ?? 0;

        world.setAttribute('rotation', `0 ${y} 0`);
        state.lastWorldY = y;
      }

      // Beobachte, wenn AR.js Styles am Video verändert (Margin-/Size-Tricks), dann neutralisieren und protokollieren
      function observeVideoMutations(v) {
        if (!v) return;
        const mo = new MutationObserver(muts => {
          for (const m of muts) {
            if (m.type === 'attributes' && m.attributeName === 'style') {
              const s = v.getAttribute('style') || '';
              if (/margin-left|margin-top|width:\s*\d+px|height:\s*\d+px/.test(s)) {
                state.notes.push('AR.js style adjust detected -> neutralized');
                // Direkt wieder unsere Regeln anwenden
                applyVideoTransform(v);
                logOverlay();
              }
            }
          }
        });
        mo.observe(v, { attributes: true, attributeFilter: ['style'] });
      }

      // AR.js System-Funktionen vorsichtig hooken (nur im Debug-Mode)
      function tryPatchArjs() {
        if (!DEBUG) return;
        const scene = document.querySelector('a-scene');
        const sys = scene?.systems?.arjs || scene?.systems?.'mindar' /* noop fallback */;
        const source = sys?.source || sys?.arSource || sys?.videoSource;
        // onResize Hook (falls vorhanden)
        const f = source?.onResizeElement || sys?.onResize || null;
        if (typeof f === 'function') {
          const original = f.bind(source || sys);
          const wrapper = function() {
            const r = original();
            // Nach AR.js Resize unsere Neutralisierung anwenden
            waitForVideo(v => {
              state.notes.push('onResize hook applied');
              applyVideoTransform(v);
              logOverlay();
            }, 0);
            return r;
          };
          try {
            if (source && source.onResizeElement) source.onResizeElement = wrapper;
            else if (sys && sys.onResize) sys.onResize = wrapper;
          } catch(e) {
            state.notes.push('patch failed: ' + e.message);
          }
        }
      }

      function fullUpdate() {
        waitForVideo(v => {
          applyVideoTransform(v);
          logOverlay();
        });
        applyWorldRotation();
        logOverlay();
      }

      // Start
      waitForVideo(v => {
        observeVideoMutations(v);
        applyVideoTransform(v);
        tryPatchArjs();
        logOverlay();
      });

      // Events
      window.addEventListener('resize', () => { fullUpdate(); });
      window.addEventListener('orientationchange', () => setTimeout(fullUpdate, 120));
      screen.orientation && screen.orientation.addEventListener?.('change', () => setTimeout(fullUpdate, 120));

      // Periodischer Refresh im Debug
      if (DEBUG) setInterval(logOverlay, 1000);
    })();
    // ========= Ende Diagnose =========

  </script>
</body>
</html>
