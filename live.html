<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <!-- Verhindert Auto-/Font-Zoom + nutzt die tatsächliche Gerätehöhe im Landscape -->
  <meta name="viewport"
        content="width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
  <title>Live – AR-Modus</title>

  <style>
    :root{ --bg:transparent; --text:#212121; --muted:#4b5563; --accent:#F39205; --border:#d0d0d0 }
    *{ box-sizing:border-box }
    html, body{ width:100%; height:100%; margin:0; -webkit-text-size-adjust:100%; text-size-adjust:100%; background:var(--bg); color:var(--text) }

    /* Szene: vollflächig unter allem */
    .scene-wrap{
      position:fixed; inset:0; z-index:1; background:transparent; overflow:hidden;
    }
    a-scene{
      position:absolute !important; inset:0 !important;
      width:100% !important; height:100% !important;
      background:transparent !important; display:block;
      touch-action:none;
    }
    /* A-Frame Canvas wirklich an den Viewport binden */
    a-scene canvas.a-canvas, a-scene .a-canvas{
      position:absolute !important; inset:0 !important;
      width:100% !important; height:100% !important; display:block !important;
      transform:none !important;
    }
    /* AR.js Kamera-Video hart einpassen (überstimmt Inline-Styles von AR.js) */
    #arjs-video, .arjs-video{
      position:absolute !important; inset:0 !important;
      width:100% !important; height:100% !important;
      margin:0 !important; top:0 !important; left:0 !important;
      right:0 !important; bottom:0 !important;
      transform:none !important; object-fit:cover !important;
      max-width:none !important; max-height:none !important;
      z-index:-2 !important;
    }

    /* Overlays */
    header, .footer-main, .footer-secondary{
      position:fixed; left:0; right:0; background:#fff; z-index:10;
    }
    header{ top:0; border-bottom:1px solid var(--border) }
    .footer-main{ bottom:22px; border-top:1px solid var(--border) }
    .footer-secondary{ bottom:0; border-top:1px solid var(--border); border-bottom:1px solid var(--border) }

    .header-inner, .footer-inner, .footer-secondary-inner{
      max-width:1200px; margin:0 auto; padding:16px 20px;
      display:flex; align-items:center; justify-content:center; gap:18px; flex-wrap:wrap;
    }
    .footer-secondary-inner{ padding:5px 18px }
    .site-title{ text-align:left; line-height:1.1 }
    .site-title .top, .site-title .bottom{ font-weight:700; font-size:clamp(20px,3vw,28px) }
    .logo{ height:clamp(40px,4.3vw,60px); width:auto }

    .btn{
      background:var(--accent); color:#0b0c10; font-weight:800; letter-spacing:.3px;
      font-size:clamp(17px,2.6vw,20px); padding:14px 25px; border:0; border-radius:0; cursor:pointer;
    }
    .footer-lab{ color:var(--muted); font-size:11px }
    .footer-lab strong{ font-weight:600 }
  </style>

  <!-- A-Frame + AR.js -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="header-inner">
      <div class="site-title">
        <div class="top">Technologiepark</div>
        <div class="bottom">&amp; Studierendenzentrum</div>
      </div>
      <img class="logo" src="./images/thlogoweiss.svg" alt="Logo" />
    </div>
  </header>

  <!-- Szene -->
  <div class="scene-wrap">
    <a-scene
      renderer="alpha:true; logarithmicDepthBuffer:true; pixelRatio: 1"
      embedded
      loading-screen="enabled:false"
      xr-mode-ui="enabled:false"
      arjs="sourceType: webcam; gpsMinDistance: 2; debugUIEnabled: false;">
      <a-assets>
        <a-asset-item id="animated-asset" src="./assets/gameobjectohnekellerreduziert.glb"></a-asset-item>
      </a-assets>

      <a-entity id="world-yaw" rotation="0 0 0">
        <a-entity gps-entity-place="latitude: 47.867615758; longitude: 12.109218307;">
          <a-entity gltf-model="#animated-asset" scale="0.8 0.8 0.8" position="-20 -4 -10"></a-entity>
        </a-entity>
      </a-entity>

      <a-camera id="cam"
        gps-camera="simulateLatitude: 47.866880722; simulateLongitude: 12.109128178;"
        rotation-reader></a-camera>
    </a-scene>
  </div>

  <!-- Footer -->
  <div class="footer-main">
    <div class="footer-inner">
      <button class="btn" id="backBtn">Zurück</button>
      <button class="btn" id="gpsBtn">GPS ein</button>
    </div>
  </div>
  <div class="footer-secondary">
    <div class="footer-secondary-inner">
      <span class="footer-lab"><strong>Labor für digitales Planen und Bauen</strong> – RaumS 0.36</span>
    </div>
  </div>

  <script>
    // Zurück zur Startseite
    document.getElementById('backBtn')?.addEventListener('click', ()=> location.href = 'index.html');

    // iOS-Orientierungsfix (wie gehabt)
    (function(){
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent)
        || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      if(!isIOS) return;
      const world = document.getElementById('world-yaw'); if(!world) return;
      const OFFSETS = { 'portrait-primary':0, 'portrait-secondary':180, 'landscape-primary':90, 'landscape-secondary':-90 };
      const ang = ()=> (screen.orientation && typeof screen.orientation.angle==='number') ? screen.orientation.angle
                    : (typeof window.orientation==='number' ? window.orientation : 0);
      const norm = a=>{ a=((a%360)+360)%360; if(a>180)a-=360; return a; };
      const type = ()=>{ const a=norm(ang()); if(a===0) return 'portrait-primary';
        if(Math.abs(a)===180) return 'portrait-secondary';
        if(a===90) return 'landscape-primary';
        if(a===-90) return 'landscape-secondary';
        return 'portrait-primary';
      };
      const apply = ()=> world.setAttribute('rotation', `0 ${OFFSETS[type()]} 0`);
      apply(); window.addEventListener('orientationchange', apply, {passive:true});
    })();

    // GPS Toggle (Simulation ↔ echtes GPS)
    const cam = document.getElementById('cam');
    const gpsBtn = document.getElementById('gpsBtn');
    let gpsOn = false;
    function applyGPS(){
      if(!cam) return;
      if(gpsOn){ cam.setAttribute('gps-camera','minAccuracy: 50'); gpsBtn.textContent='GPS aus'; }
      else     { cam.setAttribute('gps-camera','simulateLatitude: 47.866880722; simulateLongitude: 12.109128178;'); gpsBtn.textContent='GPS ein'; }
    }
    gpsBtn?.addEventListener('click', ()=>{ gpsOn = !gpsOn; applyGPS(); });
    applyGPS();

    // === Chrome-Landscape Resize-Fix ===
    const sceneEl = document.querySelector('a-scene');
    function resizeFix(){
      try{
        const r = sceneEl.renderer;
        if (r){
          // sicherstellen, dass nichts „hochskaliert“
          r.setPixelRatio(1);
          r.setSize(window.innerWidth, window.innerHeight, false);
        }
        const canvas = sceneEl.canvas;
        if (canvas){
          canvas.style.width = '100%';
          canvas.style.height = '100%';
          canvas.style.transform = 'none';
        }
        // Video ggf. neu einpassen
        const v = document.getElementById('arjs-video');
        if (v){
          v.style.width='100%';
          v.style.height='100%';
          v.style.margin='0';
          v.style.left='0'; v.style.top='0';
          v.style.transform='none';
        }
      }catch(e){}
    }
    if (sceneEl.hasLoaded) resizeFix(); else sceneEl.addEventListener('loaded', resizeFix);
    window.addEventListener('resize', resizeFix);
    window.addEventListener('orientationchange', () => setTimeout(resizeFix, 50));
  </script>
</body>
</html>
