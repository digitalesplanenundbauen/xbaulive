<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live – AR-Modus</title>
  <!-- =======================
       Grundstyling
       ======================= -->
  <style>
    :root{ --bg:#ffffff; --text:#212121; --muted:#4b5563; --accent:#F39205; --border:rgba(0,0,0,0.08); --radius:0 }
    *{ box-sizing:border-box }
    html,body{ height:100%; margin:0 }
    body{ font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; color:var(--text); background:var(--bg); display:grid; grid-template-rows:auto 1fr auto; min-height:100dvh; overflow:hidden }
    header{ 
      text-align:center; 
      position:sticky; 
      top:0; 
      z-index:10; 
      background:#fff; 
      border-bottom:1px solid #d0d0d0; /* dünnere Linie wie in index.html */
    }
    .header-inner{ max-width:1200px; margin:0 auto; padding:16px 20px; display:flex; align-items:center; justify-content:center; gap:18px }
    .site-title{ text-align:left; line-height:1.1 }
    .site-title .top,.site-title .bottom{ font-weight:700; font-size:clamp(20px,3vw,28px) }
    .logo{ height:clamp(40px,4.3vw,60px); width:auto }
    main{ position:relative; min-height:0 }
    #content-preview{ position:absolute; inset:0; background:transparent }
    a-scene{ 
      width:100%; 
      height:100%; 
      display:block; 
      touch-action:none; 
      background:transparent !important;
    }
    /* AR.js Video-Stream Fix - kritisch für korrekte Darstellung */
    #arjs-video {
      position: absolute !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      width: 100% !important;
      height: 100% !important;
      max-width: 100vw !important;
      max-height: 100vh !important;
      object-fit: cover !important;
      z-index: -2 !important;
    }
    footer{ 
      position:sticky; 
      bottom:0; 
      z-index:10; 
      background:#fff; 
      border-top:1px solid #d0d0d0; /* dünnere Linie wie in index.html */
      text-align:center 
    }
    .footer-inner{ max-width:1200px; margin:0 auto; padding:17px 22px; display:flex; gap:17px; align-items:center; justify-content:center; flex-wrap:wrap }
    .live-btn{ background:var(--accent); color:#0b0c10; font-weight:800; letter-spacing:0.3px; font-size:clamp(17px,2.6vw,20px); padding:14px 25px; border:0; border-radius:var(--radius); cursor:pointer }
    .footer-text{ font-size:clamp(15px,2.3vw,18px); color:var(--muted) }
    .footer-secondary {
      background: #fff;
      border-top: 1px solid #d0d0d0;
      border-bottom: 1px solid #d0d0d0; /* dünnere untere Trennlinie */
      text-align: center;
      font-size: 11px;
      padding: 0;
    }
    .footer-secondary-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 5px 18px 5px 18px;
    }
    .footer-lab {
      color: #4b5563;
      font-size: 11px;
      font-weight: 400;
    }
    .footer-lab strong {
      font-weight: 500;
    }
  </style>
  <!-- =======================
       A-Frame + AR.js
       ======================= -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
</head>
<body>
  <!-- =======================
       Kopfzeile
       ======================= -->
  <header>
    <div class="header-inner">
      <div class="site-title">
        <div class="top">Technologiepark</div>
        <div class="bottom">&amp; Studierendenzentrum</div>
      </div>
      <img class="logo" src="./images/thlogoweiss.svg" alt="Logo" />
    </div>
  </header>

  <!-- =======================
       Hauptbereich: AR-Szene
       ======================= -->
  <main>
    <div id="content-preview">
      <a-scene
        renderer="logarithmicDepthBuffer: true; alpha: true; precision: medium;"
        embedded
        loading-screen="enabled: false;"
        xr-mode-ui="enabled: false"
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;">
        <!-- GLB aus Assets (sauberes Preload) -->
        <a-assets>
          <a-asset-item id="animated-asset" src="./assets/gameobjectohnekellerreduziert.glb"></a-asset-item>
        </a-assets>
        <!-- Welt-Node + Geoposition -->
        <a-entity id="world-yaw" rotation="0 0 0">
          <a-entity gps-entity-place="latitude: 47.867615758; longitude: 12.109218307;">
            <a-entity gltf-model="#animated-asset" scale="0.8 0.8 0.8" position="-20 -4 -10"></a-entity>
          </a-entity>
        </a-entity>
        <!-- Kamera (Simulation an / echtes GPS per Button) -->
        <a-camera id="cam" gps-camera="simulateLatitude: 47.866880722; simulateLongitude: 12.109128178; gpsMinDistance: 5;" rotation-reader></a-camera>
      </a-scene>
    </div>
  </main>

  <!-- =======================
       Fußzeile
       ======================= -->
  <footer>
    <div class="footer-inner">
      <button class="live-btn" id="backBtn">Zurück</button>
      <button class="live-btn" id="gpsBtn">GPS ein</button>
    </div>
  </footer>
  <footer class="footer-secondary">
    <div class="footer-secondary-inner">
      <span class="footer-lab"><strong>Labor für digitales Planen und Bauen</strong> – Raum S 0.36</span>
    </div>
  </footer>
  <style>
    .footer-secondary {
      background: #fff;
      border-top: 1px solid #d0d0d0;
      border-bottom: 1px solid #d0d0d0; /* dünnere untere Trennlinie */
      text-align: center;
      font-size: 11px;
      padding: 0;
    }
    .footer-secondary-inner {
      max-width: 1200px;
      margin: 0 auto;
      padding: 5px 18px 5px 18px;
    }
    .footer-lab {
      color: #4b5563;
      font-size: 11px;
      font-weight: 400;
    }
    .footer-lab strong {
      font-weight: 500;
    }
  </style>

  <!-- =======================
       Interaktion & Funktion
       ======================= -->
  <script>
    // Navigation zurück zur Startseite
    document.getElementById('backBtn')?.addEventListener('click',()=>location.href='index.html');

    // AR.js Video-Constraint-Override - behebt Skalierungsprobleme
    (function fixARJSVideo() {
      const originalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
      
      navigator.mediaDevices.getUserMedia = function(constraints) {
        // Optimierte Video-Constraints für mobile Geräte
        if (constraints && constraints.video) {
          const isLandscape = window.innerWidth > window.innerHeight;
          
          constraints.video = {
            facingMode: { ideal: 'environment' },
            width: { ideal: isLandscape ? 1280 : 720 },
            height: { ideal: isLandscape ? 720 : 1280 },
            aspectRatio: { ideal: window.innerWidth / window.innerHeight }
          };
        }
        
        return originalGetUserMedia(constraints);
      };
    })();

    // Erweiterte Orientierungs-Behandlung für alle Geräte
    (function handleOrientation() {
      const world = document.getElementById('world-yaw'); 
      if (!world) return;
      
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isAndroid = /Android/.test(navigator.userAgent);
      const isFirefox = /Firefox/.test(navigator.userAgent);
      
      function getRotation() {
        const angle = screen.orientation?.angle ?? window.orientation ?? 0;
        const normalized = ((angle % 360) + 360) % 360;
        
        // Firefox braucht invertierte Rotation im Landscape
        if (isFirefox && (normalized === 90 || normalized === 270)) {
          return normalized === 90 ? -90 : 90;
        }
        
        // Android Standard-Rotationen
        if (isAndroid) {
          if (normalized === 0) return 0;
          if (normalized === 90) return -90;
          if (normalized === 180) return 180;
          if (normalized === 270) return 90;
        }
        
        // iOS Standard-Rotationen
        if (normalized === 90) return 90;
        if (normalized === 270) return -90;
        if (normalized === 180) return 180;
        
        return 0;
      }
      
      function applyRotation() {
        const rotation = getRotation();
        world.setAttribute('rotation', `0 ${rotation} 0`);
        
        // Video-Element nachträglich korrigieren
        setTimeout(() => {
          const video = document.getElementById('arjs-video');
          if (video) {
            video.style.width = '100%';
            video.style.height = '100%';
            video.style.maxWidth = '100vw';
            video.style.maxHeight = '100vh';
            video.style.objectFit = 'cover';
            video.style.position = 'absolute';
            video.style.top = '50%';
            video.style.left = '50%';
            video.style.transform = 'translate(-50%, -50%)';
          }
        }, 100);
      }
      
      applyRotation();
      window.addEventListener('orientationchange', () => setTimeout(applyRotation, 100));
      screen.orientation?.addEventListener('change', applyRotation);
    })();

    // GPS-Toggle mit verbesserter Konfiguration
    const cam = document.getElementById('cam');
    const gpsBtn = document.getElementById('gpsBtn');
    let gpsOn = false;
    
    function applyGPS() {
      if (!cam) return;
      if (gpsOn) { 
        cam.setAttribute('gps-camera', 'minAccuracy: 50; gpsMinDistance: 5'); 
        gpsBtn.textContent = 'GPS aus'; 
      } else { 
        cam.setAttribute('gps-camera', 'simulateLatitude: 47.866880722; simulateLongitude: 12.109128178; gpsMinDistance: 5'); 
        gpsBtn.textContent = 'GPS ein'; 
      }
    }
    
    gpsBtn?.addEventListener('click', () => { gpsOn = !gpsOn; applyGPS(); });
    applyGPS();

    // Critical: Video-Fix nach Szenen-Laden
    document.querySelector('a-scene')?.addEventListener('loaded', () => {
      setTimeout(() => {
        const video = document.getElementById('arjs-video');
        if (video) {
          video.style.width = '100%';
          video.style.height = '100%';
          video.style.maxWidth = '100vw';
          video.style.maxHeight = '100vh';
          video.style.objectFit = 'cover';
          video.style.position = 'absolute';
          video.style.top = '50%';
          video.style.left = '50%';
          video.style.transform = 'translate(-50%, -50%)';
          video.style.zIndex = '-2';
        }
      }, 500);
    });
  </script>
</body>
</html>
