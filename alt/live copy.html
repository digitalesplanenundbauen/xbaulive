<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live – AR-Modus</title>

  <!-- =======================
       BASISSTYLING
       ======================= -->
  <style>
    :root {
      --bg:#ffffff;
      --text:#212121;
      --accent:#F39205;
      --border:rgba(0,0,0,0.08);
    }
    html,body {
      margin:0; height:100%;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text); background:var(--bg);
      display:grid; grid-template-rows:auto 1fr auto; overflow:hidden;
    }
    header {
      background:#fff; border-bottom:1px solid var(--border);
      text-align:center; z-index:10;
    }
    .header-inner {
      max-width:1200px; margin:0 auto; padding:16px 20px;
      display:flex; align-items:center; justify-content:center; gap:18px;
    }
    .site-title .top,.site-title .bottom {
      font-weight:700; font-size:clamp(20px,3vw,28px);
    }
    .logo { height:clamp(50px,4.3vw,60px); width:auto; }
    main { position:relative; min-height:0; }
    #content-preview { position:absolute; inset:0; background:var(--bg); }
    a-scene { width:100%; height:100%; display:block; touch-action:none; }
    footer {
      background:#fff; border-top:1px solid var(--border);
      text-align:center; z-index:10;
    }
    .footer-inner {
      max-width:1200px; margin:0 auto; padding:14px 20px;
      display:flex; gap:14px; align-items:center; justify-content:center; flex-wrap:wrap;
    }
    .btn {
      background:var(--accent); color:var(--text);
      font-weight:800; font-size:clamp(16px,2.5vw,18px);
      padding:12px 22px; border:none; cursor:pointer;
    }
  </style>

  <!-- =======================
       A-FRAME + AR.JS
       ======================= -->
  <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>
</head>

<body>
  <!-- Kopfbereich -->
  <header>
    <div class="header-inner">
      <div class="site-title">
        <div class="top">Technologiepark</div>
        <div class="bottom">&amp; Studierendenzentrum</div>
      </div>
      <img class="logo" src="./images/thlogoweiss.svg" alt="Logo">
    </div>
  </header>

  <!-- AR-Szene -->
  <main>
    <div id="content-preview">
      <a-scene
        renderer="logarithmicDepthBuffer: true;"
        embedded
        loading-screen="enabled: false;"
        xr-mode-ui="enabled: false"
        arjs="sourceType: webcam; gpsMinDistance: 2; debugUIEnabled: false;">
        
        <!-- GLB-Modell -->
        <a-assets>
          <a-asset-item id="animated-asset" src="./assets/gameobjectohnekellerreduziert.glb"></a-asset-item>
        </a-assets>

        <!-- Welt-Ausrichtung + GPS-Position -->
        <a-entity id="world-yaw" rotation="0 0 0">
          <a-entity gps-entity-place="latitude: 47.867615758; longitude: 12.109218307;">
            <a-entity gltf-model="#animated-asset" scale="0.8 0.8 0.8" position="-20 -4 -10"></a-entity>
          </a-entity>
        </a-entity>

        <!-- Kamera (Simulation oder echtes GPS) -->
        <a-camera id="cam" gps-camera="simulateLatitude: 47.866880722; simulateLongitude: 12.109128178;" rotation-reader></a-camera>
      </a-scene>
    </div>
  </main>

  <!-- Footer mit GPS-Button -->
  <footer>
    <div class="footer-inner">
      <button class="btn" id="backBtn">Zurück</button>
      <button class="btn" id="gpsBtn">GPS ein</button>
    </div>
  </footer>

  <!-- =======================
       LOGIK (Navigation + GPS)
       ======================= -->
  <script>
    // Navigation: zurück zur Startseite
    document.getElementById('backBtn')?.addEventListener('click',()=>location.href='index.html');

    // iOS Orientierungskorrektur (dreht Modell korrekt mit Gerät)
    (function(){
      const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) ||
                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      if(!isIOS) return;
      const world = document.getElementById('world-yaw');
      if(!world) return;
      const OFFSETS = {
        'portrait-primary':0,
        'portrait-secondary':180,
        'landscape-primary':90,
        'landscape-secondary':-90
      };
      function getScreenAngle(){
        if(screen.orientation && typeof screen.orientation.angle==='number') return screen.orientation.angle;
        if(typeof window.orientation==='number') return window.orientation;
        return 0;
      }
      function normalize(a){ a=((a%360)+360)%360; if(a>180)a-=360; return a; }
      function getType(){
        if(screen.orientation && screen.orientation.type) return screen.orientation.type;
        const ang=normalize(getScreenAngle());
        if(ang===0)return'portrait-primary';
        if(ang===180||ang===-180)return'portrait-secondary';
        if(ang===90)return'landscape-primary';
        if(ang===-90)return'landscape-secondary';
        return'portrait-primary';
      }
      function applyFix(){
        const t=getType();
        const yaw=OFFSETS[t]??0;
        world.setAttribute('rotation',`0 ${yaw} 0`);
      }
      applyFix();
      window.addEventListener('orientationchange',applyFix);
    })();

    // GPS-Toggle: Simulation ↔ echtes GPS
    const cam = document.getElementById('cam');
    const gpsBtn = document.getElementById('gpsBtn');
    let gpsOn = false;

    function applyGPS(){
      if(!cam) return;
      if(gpsOn){
        cam.setAttribute('gps-camera','minAccuracy: 50');
        gpsBtn.textContent='GPS aus';
      } else {
        cam.setAttribute('gps-camera','simulateLatitude: 47.866880722; simulateLongitude: 12.109128178;');
        gpsBtn.textContent='GPS ein';
      }
    }

    gpsBtn?.addEventListener('click',()=>{ gpsOn=!gpsOn; applyGPS(); });
    applyGPS();
  </script>
</body>
</html>