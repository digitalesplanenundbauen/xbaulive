<!doctype html>
<html>
  <head>
    <meta charset="utf-8"/>
    <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
    <script src="https://aframe.io/releases/1.7.1/aframe.min.js"></script>

    <!-- AR.js (Location-based) -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/three.js/build/ar-threex-location-only.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/3.4.7/aframe/build/aframe-ar.js"></script>

    <style>
      #info-box {
        position: fixed; bottom: 0; left: 0; width: 100%;
        background: rgba(221,221,221,0.7); color:#000; font-family:sans-serif;
        font-size:14px; padding:10px; box-sizing:border-box; text-align:left; z-index:10;
      }
    </style>
  </head>

  <body style="margin:0; overflow:hidden;">
    <a-scene
      id="scene"
      renderer="logarithmicDepthBuffer: true; alpha: true;"  <!-- alpha true: AR-Video sichtbar -->
      embedded
      loading-screen="enabled: false;"
      arjs="sourceType: webcam; gpsMinDistance: 2; debugUIEnabled: false;"
    >
      <a-assets>
        <!-- AR-Modell -->
        <a-asset-item id="ar-asset" src="assets/gameobjectohnekellerreduziert.glb"></a-asset-item>
        <!-- Inspect-Modell (gleiches Objekt in anderer LOD/Variante) -->
        <a-asset-item id="inspect-asset" src="assets/gameobject.glb"></a-asset-item>
      </a-assets>

      <a-entity id="world-yaw" rotation="0 0 0">
        <a-entity gps-entity-place="latitude: 47.867615758; longitude: 12.109218307;">
          <!-- Manipulierbares Objekt -->
          <a-entity id="ar-model"
                    gltf-model="#ar-asset"
                    position="-20 -4 -10"
                    scale="0.8 0.8 0.8"
                    touch-manipulator="inspectModel:#inspect-asset; arModel:#ar-asset">
          </a-entity>
        </a-entity>
      </a-entity>

      <!-- Simulierte GPS-Kamera (für echten Betrieb s. Kommentar) -->
      <a-camera gps-camera="simulateLatitude:47.866880722; simulateLongitude:12.109128178;" rotation-reader></a-camera>
      <!-- ECHT: <a-camera gps-camera="minAccuracy:50" rotation-reader></a-camera> -->
    </a-scene>

    <div id="info-box">Modus: <strong>AR</strong> – 1 Finger: drehen • 2 Finger: zoomen • 2 Finger ziehen: verschieben</div>

    <!-- iOS-Ausrichtungsfix -->
    <script>
      (function () {
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
        if (!isIOS) return;
        const world = document.getElementById('world-yaw'); if (!world) return;
        const OFFSETS = {'portrait-primary':0,'portrait-secondary':180,'landscape-primary':90,'landscape-secondary':-90};
        function ang(){ if (screen.orientation && typeof screen.orientation.angle==='number') return screen.orientation.angle;
                        if (typeof window.orientation==='number') return window.orientation; return 0; }
        function norm(a){ a=((a%360)+360)%360; if(a>180)a-=360; return a; }
        function type(){ if (screen.orientation?.type) return screen.orientation.type;
                         const a=norm(ang()); if(a===0) return 'portrait-primary';
                         if(a===180||a===-180) return 'portrait-secondary';
                         if(a===90) return 'landscape-primary';
                         if(a===-90) return 'landscape-secondary'; return 'portrait-primary'; }
        function apply(){ const yaw=OFFSETS[type()]??0; world.setAttribute('rotation',`0 ${yaw} 0`); }
        apply(); window.addEventListener('orientationchange', apply);
      })();
    </script>

    <!-- Touch-Manipulator (Rotation, Pinch-Scale, Zwei-Finger-Pan) + Hintergrund/Model-Swap -->
    <script>
      AFRAME.registerComponent('touch-manipulator', {
        schema: {
          inspectModel: {type: 'selector'}, // <a-asset-item> für Inspect
          arModel:      {type: 'selector'}  // <a-asset-item> für AR
        },
        init: function () {
          this.scene    = document.querySelector('#scene');
          this.info     = document.querySelector('#info-box');
          this.videoEl  = document.querySelector('video'); // AR.js Video (optional)
          this.isManip  = false;

          // Gesture state
          this.startRotY = 0;
          this.startScale = new THREE.Vector3(1,1,1);
          this.startPos = new THREE.Vector3();
          this.touch0Start = null;
          this.touch1Start = null;
          this.startDist = 0;

          // Bind
          this.onStart = this.onStart.bind(this);
          this.onMove  = this.onMove.bind(this);
          this.onEnd   = this.onEnd.bind(this);

          // Listeners global (damit auch bei großem Fingerbereich sicher)
          document.addEventListener('touchstart', this.onStart, {passive:false});
          document.addEventListener('touchmove',  this.onMove,  {passive:false});
          document.addEventListener('touchend',   this.onEnd,   {passive:true});
          document.addEventListener('touchcancel',this.onEnd,   {passive:true});
        },

        enterInspect: function () {
          if (this.isManip) return;
          this.isManip = true;

          // Hintergrund opak setzen (AR-Video „ausblenden“)
          try {
            this.scene.renderer.setClearColor('#f0f0f0', 1);   // Farbe + volle Deckkraft
            this.scene.renderer.setClearAlpha(1);
          } catch(e){}

          // AR-Video pausieren (optional, schont Akku)
          try { if (this.videoEl && !this.videoEl.paused) this.videoEl.pause(); } catch(e){}

          // Modell wechseln → Inspect
          const inspectURL = this.data.inspectModel?.getAttribute('src');
          if (inspectURL) this.el.setAttribute('gltf-model', inspectURL);

          // Info
          if (this.info) this.info.innerHTML = 'Modus: <strong>Viewer</strong> – Finger abheben, um zur AR zurückzukehren';
        },

        leaveInspect: function () {
          if (!this.isManip) return;
          this.isManip = false;

          // Hintergrund wieder transparent (AR sichtbar)
          try {
            this.scene.renderer.setClearAlpha(0);
          } catch(e){}

          // AR-Video weiterlaufen lassen
          try { if (this.videoEl && this.videoEl.paused) this.videoEl.play().catch(()=>{}); } catch(e){}

          // Modell zurück → AR
          const arURL = this.data.arModel?.getAttribute('src');
          if (arURL) this.el.setAttribute('gltf-model', arURL);

          // Info
          if (this.info) this.info.innerHTML = 'Modus: <strong>AR</strong> – 1 Finger: drehen • 2 Finger: zoomen • 2 Finger ziehen: verschieben';
        },

        onStart: function (e) {
          // Beginnt jede Geste → wechsle in Inspect
          if (e.touches.length >= 1) {
            // Ausgangswerte sichern
            const rot = this.el.getAttribute('rotation');
            this.startRotY = rot ? rot.y : 0;

            const sc = this.el.object3D.scale;
            this.startScale.copy(sc);

            const pos = this.el.object3D.position;
            this.startPos.copy(pos);

            if (e.touches.length === 1) {
              this.touch0Start = {x: e.touches[0].clientX, y: e.touches[0].clientY};
            } else if (e.touches.length >= 2) {
              this.touch0Start = {x: e.touches[0].clientX, y: e.touches[0].clientY};
              this.touch1Start = {x: e.touches[1].clientX, y: e.touches[1].clientY};
              this.startDist   = this._dist(this.touch0Start, this.touch1Start);
            }

            this.enterInspect();
          }
        },

        onMove: function (e) {
          if (!this.isManip) return;
          if (e.touches.length === 1 && this.touch0Start) {
            // 1 Finger → ROTATION um Y
            const dx = e.touches[0].clientX - this.touch0Start.x;
            const rotY = this.startRotY + dx * 0.2; // Empfindlichkeit
            const r = this.el.getAttribute('rotation') || {x:0,y:0,z:0};
            this.el.setAttribute('rotation', `${r.x} ${rotY} ${r.z}`);
            e.preventDefault();
          } else if (e.touches.length === 2 && this.touch0Start && this.touch1Start) {
            // 2 Finger → PINCH = SCALE, 2-Finger-Drag = PAN (X/Z)
            const t0 = {x:e.touches[0].clientX, y:e.touches[0].clientY};
            const t1 = {x:e.touches[1].clientX, y:e.touches[1].clientY};

            const nowDist = this._dist(t0, t1);
            const scaleFactor = THREE.MathUtils.clamp(nowDist / (this.startDist||nowDist), 0.25, 4.0);
            const newS = this.startScale.clone().multiplyScalar(scaleFactor);
            this.el.setAttribute('scale', `${newS.x} ${newS.y} ${newS.z}`);

            // PAN: Mittelpunktverschiebung relativ zum Start → in X/Z umrechnen
            const midStart = {x:(this.touch0Start.x+this.touch1Start.x)/2, y:(this.touch0Start.y+this.touch1Start.y)/2};
            const midNow   = {x:(t0.x+t1.x)/2, y:(t0.y+t1.y)/2};
            const mdx = (midNow.x - midStart.x);
            const mdy = (midNow.y - midStart.y);

            // einfache Abbildung: Pixel → Meter-Faktor (anpassen nach Geschmack)
            const kMove = 0.02; // 50 px ≈ 1 m
            const newX = this.startPos.x + mdx * kMove;
            const newZ = this.startPos.z + mdy * kMove; // nach unten ziehen → +Z (anpassen falls invertiert)
            this.el.setAttribute('position', `${newX} ${this.startPos.y} ${newZ}`);

            e.preventDefault();
          }
        },

        onEnd: function (e) {
          // Wenn keine Finger mehr aufliegen → zurück in AR
          const touches = (e.touches) ? e.touches.length : 0;
          if (touches === 0) {
            this.touch0Start = null; this.touch1Start = null; this.startDist = 0;
            this.leaveInspect();
          }
        },

        _dist: function(a,b){ const dx=b.x-a.x, dy=b.y-a.y; return Math.hypot(dx,dy); },
        remove: function(){
          document.removeEventListener('touchstart', this.onStart);
          document.removeEventListener('touchmove',  this.onMove);
          document.removeEventListener('touchend',   this.onEnd);
          document.removeEventListener('touchcancel',this.onEnd);
        }
      });
    </script>

    <div id="info-box">Version: 4.7</div>
  </body>
</html>
